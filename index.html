<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro Club Stats</title>
  <style>
    :root {
      --bg-light: #f3f3f3;
      --text-light: #333;
      --card-bg-light: rgba(0, 0, 0, 0.6);
      --badge-bg-light: #007bff;
      --footer-text-light: #777;

      --bg-dark: #121212;
      --text-dark: #ddd;
      --card-bg-dark: rgba(255, 255, 255, 0.15);
      --badge-bg-dark: #3399ff;
      --footer-text-dark: #aaa;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg-light);
      color: var(--text-light);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.dark {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .card {
      color: white;
      border-radius: 10px;
      width: 300px;
      height: 400px;
      position: relative;
      background-size: cover;
      background-position: center;
      box-shadow: 0 2px 12px rgba(0,0,0,0.4);
      overflow: hidden;
      transition: background-color 0.3s ease;
    }

    .card .overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: var(--card-bg-light);
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      transition: background-color 0.3s ease;
    }

    body.dark .card .overlay {
      background-color: var(--card-bg-dark);
    }

    .overlay h2 {
      margin: 0;
    }

    .badge {
      background-color: var(--badge-bg-light);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 8px;
      transition: background-color 0.3s ease;
    }

    body.dark .badge {
      background-color: var(--badge-bg-dark);
    }

    .stats {
      margin-top: 15px;
      font-size: 14px;
    }

    .stats p {
      margin: 4px 0;
    }

    .rank {
      position: absolute;
      top: 10px; left: 10px;
      background-color: gold;
      color: black;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 50%;
      font-size: 16px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      transition: background-color 0.3s ease;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      font-size: 14px;
      color: var(--footer-text-light);
      transition: color 0.3s ease;
    }

    body.dark footer {
      color: var(--footer-text-dark);
    }

    #match-history {
      max-width: 700px;
      margin: 30px auto;
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.15);
      color: #333;
      font-family: monospace, monospace;
      white-space: pre-wrap;
      line-height: 1.4;
      max-height: 300px;
      overflow-y: auto;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.dark #match-history {
      background: #222;
      color: #ddd;
      box-shadow: 0 0 8px rgba(255,255,255,0.1);
    }

    /* Dark mode toggle button */
    #dark-mode-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--badge-bg-light);
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease;
      z-index: 1000;
    }

    body.dark #dark-mode-toggle {
      background: var(--badge-bg-dark);
    }

  </style>
</head>
<body>
  <button id="dark-mode-toggle" aria-label="Toggle dark mode">🌙 Dark Mode</button>

  <h1>Pro Clubs Player Stats</h1>
  <div class="container" id="player-container"></div>
  <footer id="footer"></footer>

  <h2>Recent Match History</h2>
  <div id="match-history">Loading matches...</div>

  <script>
    // Dark mode toggle
    const toggleBtn = document.getElementById('dark-mode-toggle');

    function setDarkMode(enabled) {
      if (enabled) {
        document.body.classList.add('dark');
        toggleBtn.textContent = '☀️ Light Mode';
        localStorage.setItem('darkMode', 'true');
      } else {
        document.body.classList.remove('dark');
        toggleBtn.textContent = '🌙 Dark Mode';
        localStorage.setItem('darkMode', 'false');
      }
    }

    // Initialize dark mode from localStorage
    const savedDarkMode = localStorage.getItem('darkMode');
    if (savedDarkMode === 'true') {
      setDarkMode(true);
    } else {
      setDarkMode(false);
    }

    toggleBtn.addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark');
      setDarkMode(!isDark);
    });

    // Utility: format Unix timestamp (seconds) to readable date string
    function formatDate(ts) {
      const d = new Date(ts * 1000);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
    }

    // Render players to the DOM
    function renderPlayers(players) {
      const container = document.getElementById("player-container");
      container.innerHTML = '';
      const roleCount = { Midfielder: 0, Forward: 0, Defender: 0, Goalkeeper: 0 };

      players.forEach((player, index) => {
        roleCount[player.role] = (roleCount[player.role] || 0) + 1;

        const card = document.createElement("div");
        card.className = "card";
        card.style.backgroundImage = `url('${player.image}')`;
        card.innerHTML = `
          <div class="overlay">
            <div class="rank">${index + 1}</div>
            <h2>${player.username} <span class="badge">${player.role}</span></h2>
            <p><strong>Pro Name:</strong> ${player.proName} (OVR ${player.ovr})</p>
            <div class="stats">
              <p>Games Played: ${player.stats.games}</p>
              <p>Win Rate: ${player.stats.winRate}%</p>
              <p>Goals: ${player.stats.goals} | Assists: ${player.stats.assists}</p>
              <p>Shot Success Rate: ${player.stats.shotSuccess}%</p>
              <p>Passes: ${player.stats.passes}</p>
              <p>Rating: ${player.stats.rating} | Tackles: ${player.stats.tackles}</p>
            </div>
          </div>
        `;
        container.appendChild(card);
      });

      document.getElementById("footer").innerText =
        `Total Midfielders: ${roleCount.Midfielder || 0} | Forwards: ${roleCount.Forward || 0} | Defenders: ${roleCount.Defender || 0} | Goalkeepers: ${roleCount.Goalkeeper || 0}`;
    }

    // Render matches to the DOM
    function renderMatches(matches) {
      const div = document.getElementById("match-history");
      if (!matches.length) {
        div.textContent = 'No match history available.';
        return;
      }

      const lines = matches.map(m => {
        // Using your data structure: timestamp, clubs with goals, etc.
        const date = formatDate(m.timestamp || m.date || 0);
        // Find home and away clubs (first two keys in clubs object)
        const clubKeys = Object.keys(m.clubs || {});
        const homeClub = m.clubs[clubKeys[0]];
        const awayClub = m.clubs[clubKeys[1]];
        const homeName = homeClub?.details?.name || 'Home';
        const awayName = awayClub?.details?.name || 'Away';
        const homeScore = homeClub?.goals || homeClub?.score || 0;
        const awayScore = awayClub?.goals || awayClub?.score || 0;
        return `Date: ${date}\nScore: ${homeName} ${homeScore} - ${awayScore} ${awayName}`;
      });

      div.textContent = lines.join('\n\n');
    }

    // Load matches from localStorage
    function loadStoredMatches() {
      const stored = localStorage.getItem('recentMatches');
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch {
          return [];
        }
      }
      return [];
    }

    // Save matches to localStorage
    function saveStoredMatches(matches) {
      localStorage.setItem('recentMatches', JSON.stringify(matches));
    }

    // Merge new matches with stored matches, avoiding duplicates by matchId
    function mergeMatches(stored, fetched) {
      const existingIds = new Set(stored.map(m => m.matchId));
      const newUnique = fetched.filter(m => !existingIds.has(m.matchId));
      return [...newUnique, ...stored].sort((a,b) => b.timestamp - a.timestamp);
    }

    // Main fetch function
    async function fetchData() {
      try {
        // Fetch players
        console.log('Fetching players...');
        const playerRes = await fetch('/api/players');
        if (!playerRes.ok) throw new Error('Failed to fetch players');
        const playerData = await playerRes.json();

        const imageMap = {
          "ChuyLeal133": "https://images.mlssoccer.com/image/private/t_editorial_landscape_8_desktop_mobile/f_auto/lc-prd/pq0ifjpu2kvgcdzrld97",
          "therealmandem7": "https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/HakimiAchraf.jpg/960px-HakimiAchraf.jpg",
          "LB_coyote2026": "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjZRhriaZakI4AdOjBbKSEo6skFj349dGaxFhwREYVXDrxyJ2gYXU8BtpB5cvCgRUT7HN7TIOLs9497TPyt07XYC0k9U5Q4mvdyq4OUQyWeLAzNSQdrAlW31L-6tEBqa77jfMgFxhnfhDQ/s1600/I+Belong+To+Jesus+-+Kaka.jpg",
          "ElWey_10": "https://assets.goal.com/images/v3/blt83eec223151ab34a/120766b54cdc32e99f440a38842e9584f695a761.jpg?auto=webp&format=pjpg&width=3840&quality=60",
          "MauryLeal11": "https://static01.nyt.com/images/2013/07/31/sports/soccer/31iht-soccer31/31iht-soccer31-superJumbo.jpg",
          "RC-_-Wheelie": "https://metro.co.uk/wp-content/uploads/2023/01/SEI_139827784-659a.jpg?quality=90&strip=all&w=646"
        };

        const players = playerData.members.map(player => ({
          username: player.name,
          proName: player.proName || player.name,
          ovr: player.proOverall || 0,
          role: player.favoritePosition || "forward",
          image: imageMap[player.name] || '',
          stats: {
            games: player.gamesPlayed,
            winRate: player.winRate,
            goals: player.goals,
            assists: player.assists,
            shotSuccess: player.shotSuccessRate,
            passes: `${player.passesMade} (${player.passSuccessRate}%)`,
            rating: parseFloat(player.ratingAve),
            tackles: `${player.tacklesMade} (${player.tackleSuccessRate}%)`
          }
        }));

        players.sort((a, b) => b.stats.rating - a.stats.rating);

        renderPlayers(players);

        // Fetch matches
        console.log('Fetching matches...');
        const matchRes = await fetch('/api/matches');
        if (!matchRes.ok) throw new Error('Failed to fetch matches');
        const fetchedMatches = await matchRes.json();

        // Load stored matches
        const storedMatches = loadStoredMatches();

        // Merge without duplicates
        const mergedMatches = mergeMatches(storedMatches, fetchedMatches);

        // Save merged matches to localStorage
        saveStoredMatches(mergedMatches);

        // Render merged matches
        renderMatches(mergedMatches);

      } catch (err) {
        console.error('Error fetching data:', err);
        document.getElementById('player-container').innerHTML = `<p>Error: ${err.message}</p>`;
        document.getElementById('match-history').textContent = `Error: ${err.message}`;
      }
    }

    fetchData();
  </script>
</body>
</html>
