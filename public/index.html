<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro Club Stats with Matches</title>
  <style>
    /* Your existing styles here */
  </style>
</head>
<body>
  <h1>Pro Clubs Player Stats</h1>
  <div id="player-container" class="container"></div>

  <h1>Recent Match History</h1>
  <div id="match-history"></div>

  <footer id="footer"></footer>

<script>
async function fetchData() {
  try {
    // Fetch players
    const playersRes = await fetch('/api/players');
    if (!playersRes.ok) throw new Error('Failed to fetch players');
    const playersData = await playersRes.json();

    // Fetch matches
    const matchesRes = await fetch('/api/matches');
    if (!matchesRes.ok) throw new Error('Failed to fetch matches');
    const matchesData = await matchesRes.json();

    // Process and render players
    renderPlayers(playersData);

    // Process and render matches
    renderMatches(matchesData);
  } catch (err) {
    console.error(err);
    document.body.insertAdjacentHTML('beforeend', `<p style="color:red;">Error: ${err.message}</p>`);
  }
}

function renderPlayers(data) {
  const imageMap = {
    "ChuyLeal133": "https://images.mlssoccer.com/image/private/t_editorial_landscape_8_desktop_mobile/f_auto/lc-prd/pq0ifjpu2kvgcdzrld97",
    "therealmandem7": "https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/HakimiAchraf.jpg/960px-HakimiAchraf.jpg",
    "LB_coyote2026": "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjZRhriaZakI4AdOjBbKSEo6skFj349dGaxFhwREYVXDrxyJ2gYXU8BtpB5cvCgRUT7HN7TIOLs9497TPyt07XYC0k9U5Q4mvdyq4OUQyWeLAzNSQdrAlW31L-6tEBqa77jfMgFxhnfhDQ/s1600/I+Belong+To+Jesus+-+Kaka.jpg",
    "ElWey_10": "https://assets.goal.com/images/v3/blt83eec223151ab34a/120766b54cdc32e99f440a38842e9584f695a761.jpg?auto=webp&format=pjpg&width=3840&quality=60",
    "MauryLeal11": "https://static01.nyt.com/images/2013/07/31/sports/soccer/31iht-soccer31/31iht-soccer31-superJumbo.jpg",
    "RC-_-Wheelie": "https://metro.co.uk/wp-content/uploads/2023/01/SEI_139827784-659a.jpg?quality=90&strip=all&w=646"
  };

  const roleCount = { Midfielder: 0, Forward: 0, Defender: 0, Goalkeeper: 0 };
  const container = document.getElementById("player-container");
  container.innerHTML = '';

  const players = data.members.map(player => ({
    username: player.name,
    proName: player.proName || player.name,
    ovr: player.proOverall || 0,
    role: player.favoritePosition || "forward",
    image: imageMap[player.name] || '',
    stats: {
      games: player.gamesPlayed,
      winRate: player.winRate,
      goals: player.goals,
      assists: player.assists,
      shotSuccess: player.shotSuccessRate,
      passes: `${player.passesMade} (${player.passSuccessRate}%)`,
      rating: parseFloat(player.ratingAve),
      tackles: `${player.tacklesMade} (${player.tackleSuccessRate}%)`
    }
  }));

  players.sort((a,b) => b.stats.rating - a.stats.rating);

  players.forEach((player, idx) => {
    roleCount[player.role] = (roleCount[player.role] || 0) + 1;

    const card = document.createElement("div");
    card.className = "card";
    card.style.backgroundImage = `url('${player.image}')`;
    card.innerHTML = `
      <div class="overlay">
        <div class="rank">${idx + 1}</div>
        <h2>${player.username} <span class="badge">${player.role}</span></h2>
        <p><strong>Pro Name:</strong> ${player.proName} (OVR ${player.ovr})</p>
        <div class="stats">
          <p>Games Played: ${player.stats.games}</p>
          <p>Win Rate: ${player.stats.winRate}%</p>
          <p>Goals: ${player.stats.goals} | Assists: ${player.stats.assists}</p>
          <p>Shot Success Rate: ${player.stats.shotSuccess}%</p>
          <p>Passes: ${player.stats.passes}</p>
          <p>Rating: ${player.stats.rating} | Tackles: ${player.stats.tackles}</p>
        </div>
      </div>
    `;
    container.appendChild(card);
  });

  document.getElementById("footer").innerText =
    `Total Midfielders: ${roleCount.Midfielder || 0} | Forwards: ${roleCount.Forward || 0} | Defenders: ${roleCount.Defender || 0} | Goalkeepers: ${roleCount.Goalkeeper || 0}`;
}

function renderMatches(matches) {
  const matchHistoryDiv = document.getElementById('match-history');
  matchHistoryDiv.innerHTML = '';

  matches.forEach(match => {
    const date = new Date(match.timestamp * 1000);
    const dateStr = date.toLocaleDateString();

    const clubIds = Object.keys(match.clubs);
    if(clubIds.length < 2) return; // skip incomplete

    const homeClub = match.clubs[clubIds[0]];
    const awayClub = match.clubs[clubIds[1]];

    const homeTeam = homeClub?.details?.name || "Home";
    const awayTeam = awayClub?.details?.name || "Away";
    const homeScore = homeClub?.goals || "N/A";
    const awayScore = awayClub?.goals || "N/A";

    const matchDiv = document.createElement('div');
    matchDiv.textContent = `Date: ${dateStr} | Score: ${homeTeam} ${homeScore} - ${awayScore} ${awayTeam}`;
    matchHistoryDiv.appendChild(matchDiv);
  });
}

fetchData();
</script>
</body>
</html>
